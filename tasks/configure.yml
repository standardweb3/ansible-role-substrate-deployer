---
- name: Substrate Configure | Systemd Template file
  template:
    src: ./templates/substrate-node.service.j2
    dest: "/etc/systemd/system/{{ substrate_node_bin_name }}.service"
    owner: "{{ substrate_node_user }}"
    group: "{{ substrate_node_group }}"
    mode: "0644"
  register: node_startup

- name: Substrate Configure | Service start
  ansible.builtin.systemd:
    name: "{{ substrate_node_bin_name }}"
    daemon_reload: yes
    state: restarted
    enabled: yes

- name: Substrate Configure | Get service invocation ID
  command: "systemctl show -p InvocationID --value {{ substrate_node_bin_name }}"
  register: systemd_status

- name: Substrate Configure | Get logs
  command: |
    journalctl _SYSTEMD_INVOCATION_ID="{{ systemd_status.stdout }}" + INVOCATION_ID="{{ systemd_status.stdout }}"
  register: service_logs
  ignore_errors: true
  failed_when:
    - 'service_logs.stderr != ""'

- name: Substrate Configure | Service stdout
  debug:
    msg: "{{ service_logs.stdout }}"
  failed_when:
    - '"Discovered new external address for our node" not in service_logs.stdout'
    - '"error" in service_logs.stdout'

- name: Substrate Configure | Verify ports are open
  wait_for:
    port: "{{ item }}"
    timeout: 10
  when:
    - "{{ item }}"
  with_items:
    - "{{ substrate_node_p2p_port }}"
    - "{{ substrate_node_rpc_port }}"
    - "{{ substrate_node_ws_port }}"
    - "{{ substrate_node_prometheus_port }}"
